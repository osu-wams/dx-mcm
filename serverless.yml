service:
  name: osu-dx-mcm-${opt:stage, 'development'}
  description: OSU DX Multi-Channel Messaging Stack

package:
  individually: true
  exclude:
    - .git/**

plugins:
  - serverless-dotenv-plugin
  - serverless-s3-sync
  - serverless-webpack

custom: ${file(./serverless-custom.yml)}

provider:
  name: aws
  runtime: nodejs12.x
  stage: ${opt:stage, 'development'}
  region: ${opt:region, 'us-west-2'}
  stackName: ${self:service.name}
  deploymentBucket:
    name: osu-dx-mcm-deployments
    blockPublicAccess: true
  deploymentPrefix: ${self:service.name}
  environment:
    ENV: ${env:ENV}
  apiKeys:
    - ${env:AWS_APIGW_API_KEY}
  tracing: ${file(./serverless.config.${opt:stage, 'development'}.yml):provider.tracing}
  iamRoleStatements:
    - Effect: Allow
      Action:
        - sns:Publish
      Resource: !Ref apiSnsTopic
    - Effect: Allow
      Action:
        - dynamodb:GetItem
        - dynamodb:PutItem
        - dynamodb:Query
      Resource:
        - !GetAtt messagesTable.Arn
        - !Join [
            '',
            [
              !GetAtt messagesTable.Arn,
              '/index/${opt:stage, self:provider.stage}-dx-mcm-MessageStatuses',
            ],
          ]
    - Effect: Allow
      Action:
        - sqs:SendMessage
        - sqs:GetQueueUrl
        - sqs:DeleteMessage
        - sqs:ReceiveMessage
        - sqs:GetQueueAttributes
      Resource:
        - !GetAtt messagesSqsQueue.Arn
        - !GetAtt userMessagesSqsQueue.Arn
  apiGateway:
    apiKeySourceType: HEADER
  usagePlan: ${file(./serverless.config.${opt:stage, 'development'}.yml):provider.usagePlan}

functions:
  - ${file(./src/services/messages/serverless-functions.yml)}

resources: ${file(./serverless-resources.yml)}
